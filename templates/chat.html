<!DOCTYPE html>
<html>
<head>
    <title>Online Chat</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body { overflow: hidden; }

        .message {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            font-size: 14px;
            word-wrap: break-word;
        }

        .sent { background-color: #dcf8c6; align-self: flex-end; }
        .received { background-color: white; align-self: flex-start; }

        #messages { display: flex; flex-direction: column; }
    </style>
</head>

<body>
<div class="container-fluid vh-100">
  <div class="row h-100">

    <!-- LEFT SIDEBAR -->
    <div class="col-3 bg-dark text-white p-3">

        <h5>ðŸ’¬ Rooms</h5>

        <input type="text" id="newRoomName"
               class="form-control mb-2"
               placeholder="Enter room name">

        <button class="btn btn-success w-100 mb-3"
                onclick="createRoom()">Create / Join Room</button>

        <div class="list-group mb-4" id="roomList"></div>

        <h6>ðŸ‘¤ Private Chat</h6>

       <input type="text" id="privateUsername"
              class="form-control mb-2"
              placeholder="Enter username">

       <button class="btn btn-primary w-100 mb-3"
              onclick="startPrivateChat()">
              Start Private Chat
      </button>

      <div class="list-group" id="privateList"></div>


    </div>

    <!-- RIGHT CHAT AREA -->
    <div class="col-9 d-flex flex-column">

        <!-- Header -->
        <div class="p-3 border-bottom d-flex align-items-center">
            <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center"
                 style="width:40px;height:40px;">
                {{ username[0]|upper }}
            </div>
            <h6 class="ms-3 mb-0" id="chatHeader">Select room or user</h6>
        </div>

        <!-- Messages -->
        <div id="messages" class="flex-grow-1 p-3"
             style="overflow-y:auto; background:#ece5dd;"></div>

        <!-- Typing Indicator -->
        <div id="typing-indicator"
             style="height:20px; font-size:14px; color:gray; padding-left:15px;"></div>

        <!-- Input -->
        <div class="p-3 border-top bg-light">
            <div class="input-group">
                <input id="message" type="text" class="form-control"
                       placeholder="Type a message...">
                <button onclick="sendMessage()" class="btn btn-success">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>

    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>

var socket = io({ transports:["polling"], upgrade:false });

var username = "{{ username }}";

var currentRoom = null;
var selectedUser = null;

var roomConversations = {};
var privateConversations = {};

var typing = false;
var timeout = undefined;

/* ================= JOIN ================= */

socket.on("connect", function() {
    console.log("Connected");
});

/* ================= ROOM SYSTEM ================= */

function createRoom() {

    var roomName = document.getElementById("newRoomName").value.trim();
    if (roomName === "") return;

    addRoomToList(roomName);
    joinRoom(roomName);

    document.getElementById("newRoomName").value = "";
}

function addRoomToList(roomName) {

    if (document.getElementById("room-"+roomName)) return;

    var item = document.createElement("a");
    item.className = "list-group-item list-group-item-action";
    item.id = "room-"+roomName;
    item.innerText = roomName;

    item.onclick = function() {
        joinRoom(roomName);
    };

    document.getElementById("roomList").appendChild(item);
}

function joinRoom(roomName) {

    selectedUser = null;
    currentRoom = roomName;

    socket.emit("join", {
        username: username,
        room: roomName
    });

    document.getElementById("chatHeader").innerText = roomName;
    loadRoomMessages(roomName);
}

function loadRoomMessages(roomName) {

    var messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    if (roomConversations[roomName]) {
        roomConversations[roomName].forEach(displayMessage);
    }
}

/* ================= PRIVATE USERS ================= */

fetch('/users')
.then(res => res.json())
.then(data => {

    var list = document.getElementById("userList");

    data.users.forEach(function(user){

        if (user !== username) {

            var item = document.createElement("a");
            item.className = "list-group-item list-group-item-action";
            item.innerText = user;

            item.onclick = function(){
                currentRoom = null;
                selectedUser = user;
                document.getElementById("chatHeader").innerText = user;
                loadPrivateMessages(user);
            };

            list.appendChild(item);
        }
    });
});

function loadPrivateMessages(user) {

    var messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";

    if (privateConversations[user]) {
        privateConversations[user].forEach(displayMessage);
    }
}

/* ================= SEND MESSAGE ================= */

function sendMessage() {

    var input = document.getElementById("message");
    var message = input.value.trim();
    if (message === "") return;

    if (currentRoom) {

        socket.emit("room_message", {
            from: username,
            msg: message,
            room: currentRoom
        });

    } else if (selectedUser) {

        socket.emit("private_message", {
            from: username,
            to: selectedUser,
            msg: message
        });

    } else {
        alert("Select room or user");
        return;
    }

    input.value = "";
}


function startPrivateChat() {

    var user = document.getElementById("privateUsername").value.trim();

    if (user === "" || user === username) {
        alert("Enter valid username");
        return;
    }

    selectedUser = user;
    currentRoom = null;

    document.getElementById("chatHeader").innerText = user;

    addPrivateToList(user);
    loadPrivateMessages(user);

    document.getElementById("privateUsername").value = "";
}


function addPrivateToList(user) {

    if (document.getElementById("private-" + user)) return;

    var item = document.createElement("a");
    item.className = "list-group-item list-group-item-action";
    item.id = "private-" + user;
    item.innerText = user;

    item.onclick = function() {
        selectedUser = user;
        currentRoom = null;
        document.getElementById("chatHeader").innerText = user;
        loadPrivateMessages(user);
    };

    document.getElementById("privateList").appendChild(item);
}


/* ================= RECEIVE ROOM MESSAGE ================= */

socket.on("room_message", function(data){

    if (!roomConversations[data.room])
        roomConversations[data.room] = [];

    roomConversations[data.room].push(data);

    if (currentRoom === data.room)
        displayMessage(data);
});

/* ================= RECEIVE PRIVATE ================= */

socket.on("private_message", function(data){

    var chatUser = (data.from === username)
        ? data.to
        : data.from;

    if (!privateConversations[chatUser])
        privateConversations[chatUser] = [];

    privateConversations[chatUser].push(data);

    addPrivateToList(chatUser);

    if (selectedUser === chatUser)
        displayMessage(data);
});

/* ================= DISPLAY ================= */

function displayMessage(data){

    var div = document.createElement("div");
    div.classList.add("message");

    if (data.from === username)
        div.classList.add("sent");
    else
        div.classList.add("received");

    div.innerText = data.from + ": " + data.msg;

    var messagesDiv = document.getElementById("messages");
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

</script>
</body>
</html>
