<!DOCTYPE html>
<html>
<head>
    <title>Online Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { overflow: hidden; }

        .message {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            font-size: 14px;
            word-wrap: break-word;
        }

        .sent {
            background: #dcf8c6;
            align-self: flex-end;
        }

        .received {
            background: white;
            align-self: flex-start;
        }

        #messages {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div class="container-fluid vh-100">
<div class="row h-100">

    <!-- LEFT SIDEBAR -->
    <div class="col-3 bg-dark text-white p-3">

        <h5>ðŸ’¬ Rooms</h5>

        <input type="text" id="roomName"
               class="form-control mb-2"
               placeholder="Enter room name">

        <button class="btn btn-success w-100 mb-3"
                onclick="joinRoom()">Create / Join</button>

        <div class="list-group mb-4" id="roomList"></div>

        <h6>ðŸ‘¤ Private Chat</h6>

        <input type="text" id="privateUser"
               class="form-control mb-2"
               placeholder="Enter username">

        <button class="btn btn-primary w-100 mb-3"
                onclick="startPrivateChat()">Start</button>

        <div class="list-group" id="privateList"></div>

    </div>

    <!-- RIGHT SIDE -->
    <div class="col-9 d-flex flex-column">

        <div class="p-3 border-bottom">
            <h6 id="chatHeader">Select room or user</h6>
        </div>

        <div id="messages"
             class="flex-grow-1 p-3"
             style="overflow-y:auto; background:#ece5dd;"></div>

        <div id="typing-indicator"
             style="height:20px; font-size:14px; color:green; padding-left:10px;">
        </div>


        <div class="p-3 border-top bg-light">
            <div class="input-group">
                <input id="message"
                       class="form-control"
                       placeholder="Type message">
                <button onclick="sendMessage()"
                        class="btn btn-success">Send</button>
            </div>
        </div>

    </div>

</div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
var socket = io();
var username = "{{ username }}";

var currentRoom = null;
var selectedUser = null;

var roomMessages = {};
var privateMessages = {};

var typing = false;
var timeout = null;

var input = document.getElementById("message");

input.addEventListener("input", function() {

    if (!typing) {
        typing = true;

        if (currentRoom) {
            socket.emit("typing", {
                username: username,
                room: currentRoom
            });
        }
        else if (selectedUser) {
            socket.emit("typing", {
                username: username,
                to: selectedUser
            });
        }
    }

    clearTimeout(timeout);

    timeout = setTimeout(function() {
        typing = false;

        if (currentRoom) {
            socket.emit("stop_typing", { room: currentRoom });
        }
        else if (selectedUser) {
            socket.emit("stop_typing", { to: selectedUser });
        }

    }, 1000);
});


/* JOIN ROOM */
function joinRoom() {
    var room = document.getElementById("roomName").value.trim();
    if (room === "") return;

    socket.emit("join_room_event", {
        username: username,
        room: room
    });

    currentRoom = room;
    selectedUser = null;

    document.getElementById("chatHeader").innerText = room;

    addRoomToSidebar(room);

    if (!roomMessages[room])
        roomMessages[room] = [];

    loadMessages(roomMessages[room]);

    document.getElementById("roomName").value = "";
}

function addRoomToSidebar(room) {
    if (document.getElementById("room-" + room)) return;

    var item = document.createElement("a");
    item.className = "list-group-item list-group-item-action";
    item.id = "room-" + room;
    item.innerText = room;

    item.onclick = function() {
        currentRoom = room;
        selectedUser = null;
        document.getElementById("chatHeader").innerText = room;
        loadMessages(roomMessages[room] || []);
    };

    document.getElementById("roomList").appendChild(item);
}


/* PRIVATE CHAT */
function startPrivateChat() {
    var user = document.getElementById("privateUser").value.trim();
    if (user === "" || user === username) return;

    selectedUser = user;
    currentRoom = null;

    document.getElementById("chatHeader").innerText = user;

    if (!privateMessages[user])
        privateMessages[user] = [];

    addPrivateToSidebar(user);

    loadMessages(privateMessages[user]);

    document.getElementById("privateUser").value = "";
}

function addPrivateToSidebar(user) {
    if (document.getElementById("private-" + user)) return;

    var item = document.createElement("a");
    item.className = "list-group-item list-group-item-action";
    item.id = "private-" + user;
    item.innerText = user;

    item.onclick = function() {
        selectedUser = user;
        currentRoom = null;
        document.getElementById("chatHeader").innerText = user;
        loadMessages(privateMessages[user] || []);
    };

    document.getElementById("privateList").appendChild(item);
}


/* SEND MESSAGE */
function sendMessage() {
    var input = document.getElementById("message");
    var msg = input.value.trim();
    if (msg === "") return;

    if (currentRoom) {
        socket.emit("room_message", {
            from: username,
            msg: msg,
            room: currentRoom
        });
    }
    else if (selectedUser) {
        socket.emit("private_message", {
            from: username,
            to: selectedUser,
            msg: msg
        });
    }
    else {
        alert("Select room or user first");
        return;
    }

    input.value = "";
    document.getElementById("typing-indicator").innerText = "";

}


/* RECEIVE ROOM MESSAGE */
socket.on("room_message", function(data) {

    if (!roomMessages[data.room])
        roomMessages[data.room] = [];

    roomMessages[data.room].push(data);

    if (currentRoom === data.room)
        display(data);
});


/* RECEIVE PRIVATE MESSAGE */
socket.on("private_message", function(data) {

    var chatUser = (data.from === username)
        ? data.to
        : data.from;

    if (!privateMessages[chatUser])
        privateMessages[chatUser] = [];

    privateMessages[chatUser].push(data);

    if (selectedUser === chatUser)
        display(data);
});


socket.on("typing", function(data) {
    if (data.username !== username) {
        document.getElementById("typing-indicator").innerText =
            data.username + " is typing...";
    }
});

socket.on("stop_typing", function() {
    document.getElementById("typing-indicator").innerText = "";
});


/* DISPLAY */
function display(data) {
    var div = document.createElement("div");
    div.classList.add("message");

    if (data.from === username)
        div.classList.add("sent");
    else
        div.classList.add("received");

    div.innerText = data.from + ": " + data.msg;

    var box = document.getElementById("messages");
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function loadMessages(list) {
    var box = document.getElementById("messages");
    box.innerHTML = "";
    list.forEach(display);
}
</script>

</body>
</html>
